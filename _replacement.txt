# Verificar invertibilidad antes de construir las grillas A/I
ok, _ = self._gauss_jordan_steps(A, I, collect_only=True)

if self.var_animar.get():
    if not ok:
        pasos_title = tk.Label(self.result_frame, text="Pasos detallados", font=("Segoe UI", 14, "bold"),
                               bg=self.bg, fg="#b91c1c")
        pasos_title.pack(pady=(10, 4))
        pasos_frame = tk.Frame(self.result_frame, bg=self.bg)
        pasos_frame.pack(fill="both", expand=True)
        scrollbar = ttk.Scrollbar(pasos_frame)
        scrollbar.pack(side="right", fill="y")
        self.pasos_text = tk.Text(pasos_frame, height=10, wrap="none", yscrollcommand=scrollbar.set, bg="white")
        self.pasos_text.pack(side="left", fill="both", expand=True)
        scrollbar.config(command=self.pasos_text.yview)
        scrollbar_x = ttk.Scrollbar(pasos_frame, orient="horizontal", command=self.pasos_text.xview)
        scrollbar_x.pack(side="bottom", fill="x")
        self.pasos_text.configure(xscrollcommand=scrollbar_x.set)
        try:
            self.pasos_text.tag_configure("bold", font=("Consolas", 12, "bold"))
            self.pasos_text.tag_configure("comment", font=("Consolas", 10, "italic"), foreground="#555")
        except Exception:
            pass
        self._explain_failure_cde(A, self.pasos_text)
        messagebox.showerror("Sin inversa", "La matriz no es invertible por propiedades (c),(d),(e).")
        return
    self._build_augmented_view(n)
    self._render_augmented(A, I)
    self._start_animation(A, I)
else:
    if not ok:
        pasos_title = tk.Label(self.result_frame, text="Pasos detallados", font=("Segoe UI", 14, "bold"),
                               bg=self.bg, fg="#b91c1c")
        pasos_title.pack(pady=(10, 4))
        pasos_frame = tk.Frame(self.result_frame, bg=self.bg)
        pasos_frame.pack(fill="both", expand=True)
        scrollbar = ttk.Scrollbar(pasos_frame)
        scrollbar.pack(side="right", fill="y")
        self.pasos_text = tk.Text(pasos_frame, height=10, wrap="none", yscrollcommand=scrollbar.set, bg="white")
        self.pasos_text.pack(side="left", fill="both", expand=True)
        scrollbar.config(command=self.pasos_text.yview)
        scrollbar_x = ttk.Scrollbar(pasos_frame, orient="horizontal", command=self.pasos_text.xview)
        scrollbar_x.pack(side="bottom", fill="x")
        self.pasos_text.configure(xscrollcommand=scrollbar_x.set)
        try:
            self.pasos_text.tag_configure("bold", font=("Consolas", 12, "bold"))
            self.pasos_text.tag_configure("comment", font=("Consolas", 10, "italic"), foreground="#555")
        except Exception:
            pass
        self._explain_failure_cde(A, self.pasos_text)
        messagebox.showerror("Sin inversa", "La matriz no es invertible por propiedades (c),(d),(e).")
        return
    self._build_augmented_view(n)
    self._render_augmented(A, I)
    self._render_detailed_gauss_jordan(A, I)
